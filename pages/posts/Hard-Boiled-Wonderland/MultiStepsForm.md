---
title: 多步骤表单Vue3实现
author: OceanPresent
time: '2022-07-01'
lang: zh-CN
---

[[toc]]

# 需求背景

之前在网页设计课设时想做一个有多个步骤（step）的表单，但当时因为一些情况并没有实现，本文旨在理清多步骤表单的实现思路。

一些比较简单的表单（通常只有一页且表单项较少）我们采取的方法可能是将整个表单数据直接放在业务组件里，表单组件也直接写在业务组件template里。

当一个组件较大时（如题），我们应当将表单提取出来作为一个单独的组件。一个多步骤表单示例如图：

![](http://res.oceanpresent.art/blog/202207011434586.png)

我们可以提取出这种表单的特点：

1. 数据多
2. 多步骤，可以前进后退
3. 不是逐一提交，而是到最后一步统一提交

很显然，示例中这个表单需要四步，我们可以将它拆分成四个子表单，同时我们需要一个抽象的组件（*我们称之为父组件*）去把这四个子表单进行组合，进行整体管理（*控制前进后退，统一提交等*）。

# 难点
## 难点一、前进后退的实现

父组件大概是这样：

![](http://res.oceanpresent.art/blog/202207011434588.png)

要实现前进后退，其实只要控制一个active表单即可，只有被激活的表单才展示。但控制前进后退的按钮都在子表单里，因此会涉及子组件修改父组件的数据（控制step），自然会想到使用emit

示例图：

![](http://res.oceanpresent.art/blog/202207011434589.png)

----

## 难点二、父子表单数据的同步

最后是将所有子表单的数据统一提交出去，因此最终需要提交的表单数据应该保存在父组件中。这就涉及到父子组件传值，但是子组件是会修改父组件的数据的，因为父子组件的表单数据需要同步。

我想了三种方法实现：

1. v-model
2. emit
3. provide/inject

原理都大差不差：

1. 父组件将数据传入子表单
2. **子表单复制一份**
3. 监听子表单数据的变化
4. 修改父组件的数据

### 为什么要使用复制的数据

这里着重说一下第2步：为什么子表单要复制一份父组件的数据再拿去使用。

如果父组件简单地给子组件传数据的话，那么会使用props，我们都知道Vue官方并不推荐也不允许子组件修改props数据。如果要修改，通常都会使用emit（provide/inject其实同理。这里不考虑pinia）。

具体到这个组件，子组件是在<u>什么情况下</u>修改父组件<u>什么数据</u>的呢？

我们是在子组件的表单元素里修改父组件表单数据（一个Object）的某一小项数据的（一般都为基本类型）

假设我们使用emit。那么在子组件中，向某一表单元素绑定input事件触发emit，那么传入emit的也只是某一小项数据。如果每个元素都这样传，考虑到多步骤表单的特性一：数据多，那该传多少emit函数啊。因此更好的方法是：直接替换整个表单数据（一个Object）

我们在子表单里，深复制一份父组件传入的表单数据cloneForm。然后正常v-model绑定表单元素。同时为cloneForm设置一个watch（**deep需要设置为true**），如果cloneForm改变了（因为表单元素v-model的双向绑定），就触发emit替换掉整个表单数据。这样就实现了响应式同步父子表单。

示例为v-model实现，可以看到组件v-model传值本质上也是emit修改整个modelValue

无论修改父组件还是子组件的input元素，示例中的四个文字都会变化

**父组件**

![](http://res.oceanpresent.art/blog/202207011434590.png)

**子组件**

![](http://res.oceanpresent.art/blog/202207011434591.png)
